= User Profile Sample: Data Sync Fundamentals
:idprefix:
:idseparator: -
:icons: font
:quick-uri: https://asciidoctor.org/docs/asciidoc-syntax-quick-reference/
:page-aliases: tutorials:userprofile-couchbase-mobile:sync/userprofile/userprofile_sync
:page-hide-view-latest: true
ifndef::env-site,env-github[]
:toc: left
:toclevels: 3
endif::[]

toc::[]

// BEGIN Tutorial Attributes

:target-version: {major}.{minor}
:target-version-full: {major}.{minor}.{maintenance}
ifdef::releasetag[:target-version-full: {target-version-full}-{releasetag}]
:tutorial-component: {page-component-name}
:tutorial-title: {page-component-title}
:tutorial-module: {page-module}
:tutorial-section: {version}
:tutorial-platform: swift



// END Tutorial Attributes


// BEGIN Tutorial Cross-reference link

// Tutorial Links
:standalone--xref: xref:standalone@userprofile-couchbase-mobile:userprofile:userprofile_basic.adoc[Standalone]

:query--xref: xref:query@userprofile-couchbase-mobile:userprofile:userprofile_query.adoc[Query]

:sync--xref: xref:sync@userprofile-couchbase-mobile:userprofile:userprofile_sync.adoc[Sync]


//  Documentation Links
:cbl-documentation-component--xref: pass:q,a[xref:couchbase-lite:]
:cbl-documentation-module--xref: pass:q,a[{cbl-documentation-component--xref}{tutorial-platform}:]

:cbl-blobs--xref: {cbl-documentation-module--xref}blob.adoc[Working with Blobs]

:cbl-install--xref: {cbl-documentation-module--xref}gs-install.adoc[Get Started - Install]

:cbl-prepare--xref: {cbl-documentation-module--xref}gs-prepare.adoc[Get Started - Prepare]


:documentation-component--xref: pass:q,a[xref:sync-gateway:]

:documentation-module--xref: pass:q,a[{documentation-component--xref}:]

:access-control-model--xref: {documentation-module--xref}access-control.adoc[Access Control Model]

:channels--xref: {documentation-module--xref}channels.adoc[Channels]

:sync-function--xref: pass:q,a[{documentation-module--xref}sync-function.adoc[Sync Function API]]

:sync-function-api-access--xref: {documentation-module--xref}sync-function-api-access-cmd.adoc[access()]

:sync-function-api-channel--xref: {documentation-module--xref}sync-function-api-channel-cmd.adoc[channel()]

:sync-function-api-require-access--xref: {documentation-module--xref}sync-function-api-require-access-cmd.adoc[requireAccess()]

:sync-function-api-require-user--xref: {documentation-module--xref}sync-function-api-require-user-cmd.adoc[requireUser()]

:sync-gateway-docs--xref: {documentation-component--xref}:index.adoc[Sync Gateway Documentation]

:sync-gateway-overview--xref: {documentation-module--xref}configuration-overview.adoc[Sync Gateway Configuration].

:whatsnew--xref: {documentation-component--xref}:whatsnew.adoc[New in {target-version-full}] for more.


// Git Content Links

:git-sync--url: https://github.com/rajagp/userprofile-couchbase-mobile-cordova-android/blob/main/sync/

:config-filename: sync-gateway-config-userprofile-demo

:config-file-legacy--url: {git-sync--url}{config-filename}.json

:config-file--url: {git-sync--url}{config-filename}-{target-version}.json

:userprofile-demo-download--url: https://github.com/couchbaselabs/userprofile-couchbase-mobile/archive/sync.zip[here]

:userprofile-app-overview-image--url: https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/sync/content/modules/userprofile/assets/images/userprofile_app_overview.gif


// External Site Links

:mac-app-store--url: https://itunes.apple.com/us/app/xcode/id497799835?mt=12[Mac App Store^]
:github-account--url: https://github.com[free github account^]
:github-download--url: https://git-scm.com/book/en/v2/Getting-Started-Installing-Git[git-scm.org^]
:curl-download--url: https://curl.haxx.se/download.html[curl website^]
:docker-download--url: https://docs.docker.com/get-docker/[Get Docker^]



// END Tutorial Cross-reference link



== Introduction

Couchbase Sync Gateway is a key component of the Couchbase Mobile stack.
It is an Internet-facing synchronization mechanism that securely syncs data across devices as well as between devices and the cloud.
Couchbase Mobile {target-version} introduces centralized persistent module configuration of synchronization, which simplifies the administration of Sync Gateway clusters -- see {whatsnew--xref}


The core functions of the Sync Gateway include

* Data Synchronization across devices and the cloud
* Authorization & Access Control
* Data Validation

This tutorial will demonstrate how to -

* Setup a basic Couchbase Sync Gateway configuration to sync content between multiple Couchbase Lite enabled clients. We will will cover the basics of the {sync-gateway-overview--xref}

* Configure your Sync Gateway to enforce data routing, access control and authorization.
We will cover the basics of the {sync-function--xref}

* Configure your Couchbase Lite clients for replication with the Sync Gateway
* Use "Live Queries" or Query events within your Couchbase Lite clients to be asynchronously notified of changes

We will be using a Swift App as an example of a Couchbase Lite enabled client.

====
You can learn more about the Sync Gateway here in the {sync-gateway-docs--xref}.
====

== Prerequisites
This tutorial assumes familiarity with building Swift apps with Xcode and with Couchbase Lite.

* If you are unfamiliar with the basics of Couchbase Lite, it is recommended that you walk through the following tutorials

** Fundamentals of using Couchbase Lite 2.0 as a {standalone--xref} database

** {query--xref}
 with a prebuilt version of Couchbase Lite database

* iOS (Xcode 10.1+) +
Download latest version from the {mac-app-store--url}
+
NOTE: If you are on an older version of Xcode that you must retain for your other development needs, you can make a copy of your existing version of Xcode and install Xcode 10.1+. So you can have multiple versions of Xcode on your Mac.

* git (Optional) +
This is required if you would prefer to pull the source code from GitHub repo.
** Create a {github-account--url} if you don't already have one
** git can be downloaded from {github-download--url}

* curl HTTP client +
You can use any HTTP client of your choice.
But we will use *curl* in our tutorial.
Download latest version from the {curl-download--url}

* Docker +
We will be using Docker to run images of both Couchbase Server and the Sync Gateway -- to download Docker, or for more information, see: {docker-download--url}


== System Overview

We will be working with the simple "User Profile" app which we introduced in the {standalone--xref} tutorial and extended in the {query--xref} tutorial.

In this tutorial, we will be extending that app to support data sync.
It will do the following

* Allows users to log in and create or update their user profile information.
The user profile view is _automatically updated_ every time the profile information changes in the underlying database
* The user profile information is synced with a remote Sync Gateway which then syncs it to other devices (subject to access control and routing configurations specified in the `sync function`)

:alt-text: The sample user profile application running in a simulator
.{alt-text}
image::{userprofile-app-overview-image--url}[{alt-text}]

== App Installation

=== Fetching App Source Code

You have two options

==== Option 1 : Git Clone

- Clone the *_sync_* branch of the `User Profile Demo` project from GitHub. Type the following command in your terminal
+
[source,bash]
----
git clone -b sync https://github.com/couchbaselabs/userprofile-couchbase-mobile.git
----

==== Option 2 : Download .zip

- Download the `User Profile Demo` project from {userprofile-demo-download--url}

=== Installing Couchbase Lite Framework

Next, we will download the Couchbase Lite {target-version-full} framework.

The Couchbase Lite iOS framework is distributed via SPM, Cocoapods, Carthage or you can download the pre-built framework -- see the {cbl-install--xref} documentation for more information.

In our example, we will download the pre-built version of the framework.
To do this, type the following in a command terminal:

[source,bash]
----
cd /path/to/UserProfileDemo/content/modules/userprofile/examples

sh install_12.sh
----

Next, let's verify the installation.

=== Try it Out

. Open the `UserProfileDemo.xcodeproj` Xcode project file, located at +
`/path/to/UserProfileDemo/content/modules/userprofile/examples`
+
[source,bash]
----
open UserProfileDemo.xcodeproj
----

. Use Xcode to build and run the project in **two simulators**
. Verify that you see the login screen on both the simulators

:alt-text: User Profile Login Screen Image
.{alt-text}
image::user_profile_login_2.png[{alt-text}]


== Data Model
If you followed along with the {query--xref} tutorial, you can skip this section and proceed to the <<Backend Installation>> section.
We have not changed the Data model for this tutorial.

Couchbase Lite is a JSON Document Store. A Document is a logical collection of named fields and values.The values are any valid JSON types. In addition to the standard JSON types, Couchbase Lite supports some special types like `Date` and `Blob`.
While it is not required or enforced, it is a recommended practice to include a _"type"_ property that can serve as a namespace for related.

=== The User Profile Document
The app deals with a single Document with a _"type"_ property of _"user"_ as shown in  <<ex-user-profile-doc>>.
The document ID is of the form _"user::<email>"_.

.A user profile document
[#ex-user-profile-doc]
====
[source, json]
----
{
    "type":"user",
    "name":"Jane Doe",
    "email":"jame.doe@earth.org",
    "address":"101 Main Street",
    "image":CBLBlob (image/jpg),
    "university":"Rensselaer Polytechnic"
}
----
====

==== The User Record

The _"user"_ Document is encoded to a native struct named _UserRecord_ as shown in <<ex-user-rec>>

[#ex-user-rec]
.The encoding of a UserRecord to a native structure
[source,{tutorial-platform}, subs="attributes+, macros+"]
====
----
include::{examplesdir}/UserProfileDemo/model/UserRecord.swift[tags=userrecord]
----
====

=== The University Document
The app comes bundled with a collection of Documents of type _"university"_. Each Document represents a university -- see <<ex-university-doc>>

[#ex-university-doc]
.A university document
====
[source, json]
----
{
    "type":"university","web_pages": [
      "http://www.rpi.edu/"
    ],
    "name": "Rensselaer Polytechnic Institute",
    "alpha_two_code": "US",
    "state-province": null,
    "domains": [
      "rpi.edu"
    ],
    "country": "United States"
}
----
====

==== UniversityRecord

The _"university"_ Document is encoded to a native struct named _UniversityRecord_ -- as shown in <<ex-university-rec>>

[#ex-university-rec]
.The encoding of a UniversityRecord to a native structure
====
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/model/UniversityRecord.swift[tags=universityrecord]
----
====

// BEGIN Docker Text
== Backend Installation
We will install <<Couchbase Server>> and <<Sync Gateway>> using Docker.

=== Prerequisites

* You must have Docker installed on your laptop.
For more on Docker -- see: {docker-download--url}
* On Windows, you may need admin privileges.
* Ensure that you have sufficient memory and cores allocated to docker.
At Least 3GB of RAM is recommended.

=== Docker Network
Create a docker network named “workshop”

[source, bash, subs="attributes+, macros+"]
----
docker network ls

docker network create -d bridge workshop
----

=== Couchbase Server

==== Install
We have a custom docker image `priyacouch/couchbase-server-userprofile:7.0.0-dev` of  Ccouchbase Server, which creates an empty bucket named “userprofile” and an RBAC user “admin” with “sync gateway” role.

Alternatively, you can follow the instructions in our documentation -- see: {cbl-prepare--xref}, to install Couchbase Server and configure it with the relevant bucket.

[source, bash, subs="attributes+, macros+"]
----
docker stop cb-server

docker rm cb-server

docker run -d --name cb-server \
--network workshop \
-p 8091-8094:8091-8094 -p 11210:11210 \
priyacouch/couchbase-server-userprofile:7.0.0-dev

----

==== Test Server Install

The server could take a few minutes to deploy and fully initialize; so be patient.
Check the Docker logs using the command:

[source, bash, subs="attributes+, macros+"]
----
docker logs -f cb-server
----

When the setup is completed, you should see output similar to that shown in <<ex-server-setup-output>>.

[#ex-server-setup-output]
.Server set-up output
====
[source, bash, subs="attributes+, macros+"]
----
(#0)
> POST /settings/web HTTP/1.1
> Host: 127.0.0.1:8091
> User-Agent: curl/7.66.0-DEV
> Accept: */*
> Content-Length: 50
> Content-Type: application/x-www-form-urlencoded
>
} [50 bytes data]
* upload completely sent off: 50 out of 50 bytes
* Mark bundle as not supporting multiuse
< HTTP/1.1 401 Unauthorized
< Cache-Control: no-cache,no-store,must-revalidate
< Connection: close
< Content-Length: 0
< Date: Wed, 18 Aug 2021 19:53:29 GMT
< Expires: Thu, 01 Jan 1970 00:00:00 GMT
< Pragma: no-cache
< Server: Couchbase Server
< WWW-Authenticate: Basic realm="Couchbase Server Admin / REST"
< X-Content-Type-Options: nosniff
< X-Frame-Options: DENY
< X-Permitted-Cross-Domain-Policies: none
< X-XSS-Protection: 1; mode=block
<
100    50    0     0  100    50      0   4166 --:--:-- --:--:-- --:--:--  4545
* Closing connection 0
SUCCESS: Bucket created
SUCCESS: User admin set
/entrypoint.sh couchbase-server
----
====

Now you can check the required data is in place:

. Open up http://localhost:8091 in a browser
. Sign in as “Administrator” and “password” in login page

. Go to “buckets” menu and confirm “userprofile” bucket is created
+
image::confirm-bucket-created.png

. Go to “security” menu and confirm “admin” user is created
+
image::confirm-admin-user-created.png


=== Sync Gateway
Now we will <<lbl-install, Install>> <<Configure>> and <<Run>> Sync Gateway.

[#lbl-install]
==== Install

From Sync Gateway {target-version-full}, the sync{nbsp}gateway needs to be bootstrapped with a startup configuration file.
Alternatively, you can opt to run in legacy-mode and use the Pre-{target-version-full} configuration.

The configuration files corresponding to this sample application are available in the github repo hosting the app under the "sync" folder.

* The legacy version (Sync Gateway 2.x compatible) of configuration file can be found here -- {config-file-legacy--url}

* The Sync Gateway {target-version-full} compatible version of configuration file can be found here -- {config-file--url}


NOTE: When starting Sync Gateway {target-version}, only the bootstrap information needs to be provided in the config file.
The Sync Gateway database configuration is recommended to be handled via REST endpoint.

For the purposes of backward compatibility, this tutorial will continue to use the {config-file-legacy--url}[legacy compatibility mode], running with the `disable_persistent_config` option in the configuration file set to `true`.

==== Configure

. Switch to the the folder which contains the downloaded json configuration file, using:
+
[source, bash, subs="attributes+, macros+"]
----
cd /path/to/cloned/repo/sync
----

. Make sure no Sync Gateway container exists, using:
+
[source, bash, subs="attributes+, macros+"]
----

docker stop sync-gateway

docker rm sync-gateway
----

. Now we can deploy Sync Gateway and the downloaded config file in a Docker container
+
For Windows Systems:
+
[{tabs}, subs="attributes+,macros+"]
=====

Sync Gateway {target-version}::
+
--
Installing Sync Gateway {target-version}

[source, bash, subs="attributes+, macros+"]
----
docker run -p 4984-4985:4984-4985 \
--network workshop \
--name sync-gateway \
-d -v %cd%/sync-gateway-config-userprofile-demo.{target-version}.json:
/etc/sync_gateway/sync_gateway.json \
couchbase/sync-gateway:{target-version}.0-beta02-enterprise \
-adminInterface :4985 \
/etc/sync_gateway/sync_gateway.json
----
--
Sync Gateway (legacy)::
+
--
Installing Sync Gateway 2.8

[source, bash, subs="attributes+, macros+"]
----
docker run -p 4984-4985:4984-4985 \
--network workshop \
--name sync-gateway \
-d \
-v %cd%/sync-gateway-config-userprofile-demo.json\
  :/etc/sync_gateway/sync_gateway.json \
couchbase/sync-gateway:2.8.3-enterprise \
-adminInterface :4985 \
/etc/sync_gateway/sync_gateway.json
----
--
=====

+
On Non-Windows Systems
+
[{tabs}]
=====

Sync Gateway {target-version}::
+
--
Installing Sync Gateway {target-version}

[source, bash, subs="attributes+, macros+"]
----
docker run -p 4984-4985:4984-4985 -\
-network workshop \
--name sync-gateway \
-d \
-v `pwd`/sync-gateway-config-userprofile-demo.{target-version}.json:\
/etc/sync_gateway/sync_gateway.json \
couchbase/sync-gateway:3.0.0-beta02-enterprise  \
-adminInterface :4985 \
/etc/sync_gateway/sync_gateway.json
----
--

Sync Gateway (legacy)::
+
--

Installing Sync Gateway 2.8

[source, bash, subs="attributes+, macros+"]
----
non-Windows Systems:
docker run -p 4984-4985:4984-4985 \
--network workshop \
--name sync-gateway \
-d \
-v `pwd`/sync-gateway-config-userprofile-demo.json:\
/etc/sync_gateway/sync_gateway.json \
couchbase/sync-gateway:2.8.3-enterprise \
-adminInterface :4985 \
/etc/sync_gateway/sync_gateway.json
----
--

=====


==== Test Installation

Now we can confirm that the Sync Gateway is up and running.

. Check the log messages
+
[source, bash, subs="attributes+, macros+"]
----
docker logs -f sync-gateway
----
+
You will see a series of log messages.
Make sure there are no errors.

. Then open up http://localhost:4984 in browser. +
You should see equivalent of the following message
+
[source, bash, subs="attributes+, macros+"]
----
{"couchdb":"Welcome","vendor":{"name":"Couchbase Sync Gateway","version":"{target-version}"},"version":"Couchbase Sync Gateway/{version-maintenance}(145;e3f46be) EE"}
----

Now that we have the server and sync gateway backend installed, we can verify data sync between Couchbase Lite enabled apps.

// END Docker Text


== Sync Function

The Sync Function is a Javascript-function that is specified as part of the Sync Gateway Configuration
It handles <<Authorization, authorization>>, <<Data Validation,data validation,>> <<Data Routing, data routing>> and <<Access Control, access control>>.

To get started learning about this function:

. Open the configuration file you downloaded using any text editor of your choice.
It will be located in the app bundle at +
`/path/to/UserProfileDemo/content/modules/userprofile/examples`.
. Locate the `sync` setting

Now you can follow along with the rest of the sections below.

// link:https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/sync-function-api-guide/index.html#requireuserusername[`requireUser()`]

=== Authorization

We will use the Sync function's {sync-function-api-require-user--xref} API to verify that the `email` property specified in the Document matches the Id of the user making the request.
The Id of the user making the request is specified in the `Authorization` header.
We will use _Basic Authentication_ in our application -- at this stage our function will look like that shown in <<ex-auth>>.


[#ex-auth]
.Sync function -- Authorization
====
[source,javascript]
----
function sync(doc, oldDoc) {
   ....
   /* Authorization */

  // Verify the user making the request is the same as the one in doc's email
  requireUser(doc.email);
  .....
}
----
====

=== Data Validation

In this application, we will also be doing some basic validation of the contents of the Document.
To do this we will add functionality to the Sync function that is similar to that shown in <<ex-validation>>.

[#ex-validation]
.Sync function -- Data Validation
====
[source,javascript, subs="attributes+, macros+"]
----

  ...
  /* Data Validation */

  if (!isDelete()) {
    // Validate the presence of email fields
    validateNotEmpty("email", doc.email); // <.>

    // Check if document is being created / added for first time
    // We allow any user to create the document
    if (isCreate()) {

      // Validate that the document Id _id is prefixed by owner.
      var expectedDocId = "user" + "::" + doc.email;

      if (expectedDocId != doc._id) { // <.>
          throw({forbidden: "user doc Id must be of form user:email"});
      }

    } else {
        // Validate that the email hasn't changed.
      validateReadOnly("email", doc.email, oldDoc.email); // <.>
    }

  }

  /* Helper functions */

  // Verify that specified property exists
  function validateNotEmpty(key, value) {
    if (!value) {
      throw({forbidden: key + " is not provided."});
    }
  }


  // Verify that specified property value has not changed during update
  function validateReadOnly(name, value, oldValue) {
    if (value != oldValue) {
      throw({forbidden: name + " is read-only."});
    }
  }
  ...

----

<.> Verify that the `email` property is not null. If it's null, we throw a JS exception (see `validateNotEmpty()` function)
<.> If this a new document, then verify that the `Id` of the Document is of the required format (i.e. _"user::<email>"_). We throw an exception if that's not the case.
<.> If this is a document update, then verify that the `email` property value has not changed. Again, we throw an exception if that's not the case.
====

NOTE: You can learn more about the Sync Function in the documentation here: {sync-function--xref}


=== Data Routing
{channels--xref} provide a mechanism to "tag" documents.
They are typically used to route/segregate documents based on the contents of those documents -- as shown in: <<ex-routing>>.

When combined with the {sync-function-api-access--xref} and {sync-function-api-require-access--xref} API, the {sync-function-api-channel--xref} API
 can also be used to enforce <<Access Control>>.

As we shall see in a later section, clients can use channels to pull just a subset of documents.

[#ex-routing]
.Using channel() to tag/route documents
====
[source,javascript]
----
  ...
  /* Routing */
  // Subsequent updates to document must be authorized

  var email = getEmail(); // <.>

  // Add doc to the user's channel.
  channel("channel." + email); // <.>

  // get email Id property
  function getEmail() {
    return (isDelete() ? oldDoc.email : doc.email);
  }
  ...

----
<.> Retrieve the the `email` property specified in the document. We will uses this as our user and channel name
<.> The channel comes into existence the first time a document is added to it.
Here we generate the channel name from the email property.
====

=== Access Control

We can enforce access control to channels using the {sync-function-api-access--xref} API.
The approach shown in <<>> ensures that only users with access to a specific channel are able to retrieve documents in the channel.

[#ex-access]
.Controlling access to documents using channel() and access() API
====
[source,javascript]
----
  ...
  /* Access Control */
  // Give user read access to channel
   if (!isDelete()) {
    // Deletion of user document is essentially deletion of user
       access(email, // <.>
               "channel." + email) // <.>
   }
  ...
----
<.> Here we use to the email property retrieved in <<ex-routing>> as the `username`
<.> Now we specify the channel the user is allowed to access

====


== Starting Replication

Two-way Replication between the app and the Sync Gateway is enabled when the user logs into the app.

To see the code behind this, open the *DatabaseManager.swift* file and locate the `startPushAndPullReplicationForCurrentUser()` function -- as shown in: <<ex-pushpull>>.

[#ex-pushpull]
.The startPushAndPullReplicationForCurrentUser function
====
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=startPushAndPullReplicationForCurrentUser]
----
====

In the function you will see we create an instance of the `ReplicatorConfig`, which specifies the source and target database -- see: <<ex-repl-config>>.
You could also use this to, optionally, override the default configuration settings.

[#ex-repl-config]
.Creating the replicator configuration instance
====
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=replicationconfig]
----

<.> Initialize with `source` as the local Couchbase Lite database and the `remote` target as the Sync Gateway
<.> Replication `type` of `pushAndPull` indicates that we require two-way sync. A value of `.pull` specifies that we only pull data from the Sync Gateway. A value of `.push` specifies that we only push data.
<.> The `continuous` mode is specified to be _true_ which means that changes are synced in real-time. A value of _false_  which implies that data is only pulled from the Sync Gateway.
<.> This is where you specify the authentication credentials of the user. In the <<Authorization>> section, we discussed that the Sync Gateway can enforce authorization check using the `requireUser` API.
<.> The `channels` are used to specify the channels to pull from. Only documents belonging to the specified channels are synced. This is subject to <<Access Control>> rights enforced at the Sync Gateway. This means that if a client does not have access to documents in a channel, the documents will not be synched even if the client specifies it in the replicator configuration.
====

Now we initialize the `Replicator` with the `ReplicatorConfiguration` -- as shown in <<ex-init-repl>>

[#ex-init-repl]
.Initialize a replicator with our configuration details
====
[source,{tutorial-platform}]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=replicationinit]
----
====

In order to follow the replicator's progress, we can attach a callback listener to it.

Attaching a callback listener to the `Replicator` means we will be asynchronously notified of state changes.
This could be useful for instance, to inform the user of the progress of the replication.
It is an optional step and is shown here in <<ex-callback>>.

[#ex-callback]
.Attaching a callback listener
====
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=replicationlistener]
----
====

Now, with all that done, we can start the replicator -- see: <<ex-start>>.

[#ex-start]
.Starting a configured replicator
====
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=replicationstart]
----
====


== Stopping Replication
When user logs out of the app, the replication is stopped before the database is closed.

. Open the *DatabaseManager.swift* file and locate the `stopAllReplicationForCurrentUser()` function.
+
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=stopAllReplicationForCurrentUser]
----
+
. Stop the replicator and remove any associated change listeners
+
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=replicationstop]
----
+

NOTE: All open replicators must be stopped before database is closed. There will be an exception if you attempt to close the database without closing the active replicators.


== Query Events / Live Queries

Couchbase Lite applications can set up _live queries_ in order to be asynchronously notified of changes to the database that affect the results of the query.
This can be very useful, for instance, in keeping a UI View up-to-date with the results of a query.

In our app, the user profile view is kept up-to-date using a live query that fetches the user profile data used to populate the view.
This means that, if the replicator pulls down changes to the user profile, they are automatically reflected in the view.

To see this:

. Open the *UserPresenter.swift* file and locate the `fetchRecordForCurrentUserWithLiveModeEnabled()` function. Calling this function with a value of `true` implies that the caller wishes to be notified of any changes to query results.
+
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/presenter/UserPresenter.swift[tags=fetchRecordForCurrentUserWithLiveModeEnabled]
----
+
. Build the Query -- see: <<ex-query>> -- using `QueryBuilder` API. If you are unfamiliar with this API, please check out this {query--xref} tutorial.
+
[#ex-query]
.Defining a query using QueryBuilder
====
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/presenter/UserPresenter.swift[tags=livequerybuilder]
----

<.> We query for documents based on document Id.
In our app, there should be exactly one user profile document corresponding to this Id.
====

. Attach a listener callback to the query to make it _live_
+
.Attaching a listener callback to a query
====
[source,{tutorial-platform}, subs="attributes+, macros+"]
----
include::{examplesdir}/UserProfileDemo/presenter/UserPresenter.swift[tags=livequery]
----

<.> Attach a listener callback to the query. Attaching a listerner automatically makes it _live_ so any time there is a change in the user profile data in the underlying database, the callback would be invoked
<.> Create an instance of <<UserRecord>>. This will be populated with the query results.
<.> The `SelectResult.all()` method is used to query all the properties of a document. In this case, the document in the result is embedded in a dictionary where the key is the database name, which is _"userprofile"_. So we retrieve the link:http://docs.couchbase.com/mobile/2.0/couchbase-lite-swift/Classes/DictionaryObject.html[`DictionaryObject`] at key _"userprofile"_.
<.>  We use appropriate _type getters_ to retrieve values and populate the _UserRecord_ instance
====


== Exercises

=== Exercise 1
In this exercise, we will observe how changes made on one app are synced across to the other app

. Run the app side by side in two simulators
. Log into both the simulators with same userId and password. +
Use the values _"demo@example.com"_ and _"password"_ for user Id and password fields respectively
. On one simulator, enter values in the user and address fields.
. Confirm that changes show up in the app on the other simulator.
. Similarly, make changes to the app in the other simulator and confirm that the changes are synced over to the first simulator.

=== Exercise 2
In this exercise, we will observe changes made via Sync Gateway are synced over to the apps

. Make sure you complete <<Exercise 1>>.
This is to ensure that you have the appropriate user profile document (with document Id of "user::<emailId>") created through the app and synced over to the Sync Gateway.

. Open the command terminal and issue the following command to get the user profile document via link:[GET Document REST API] .
We will be using `curl` to issue the request.
If you haven't done so, please install curl as indicated in the <<Prerequisites>> section

+
[source,bash]
----
curl -X GET \
  http://localhost:4985/userprofile/user::demo@example.com \ // <.>
  -H 'Accept: application/json' \
  -H 'Cache-Control: no-cache' \
  -H 'Content-Type: application/json'
----
<.> This GET retrieves the userprofile document

. Your response should look something like the response below. The exact contents depends on the user profile information that you provided via your mobile app.
+
[source,bash]
----
{
    "_attachments": { <.>
        "blob_1": {
            "content_type": "image/jpeg",
            "digest": "sha1-S8asPSgzA+F+fp8/2DdIy4K+0U8=",
            "length": 14989,
            "revpos": 2,
            "stub": true
        }
    },
    "_id": "user::demo@example.com",
    "_rev": "2-3a76cfa911e2c54d1e82b29dbffc7f4e5a9bc265", // <.>
    "address": "",
    "email": "demo@example.com",
    "image": {
        "@type": "blob",
        "content_type": "image/jpeg",
        "digest": "sha1-S8asPSgzA+F+fp8/2DdIy4K+0U8=",
        "length": 14989
    },
    "name": "",
    "type": "user",
    "university": "British Institute in Paris, University of London"
}
----
<.> If you had updated an image via the mobile app, you should see an *"_attachments"* property. This entry holds an array of attachments corresponding to each image blob entry added by the mobile app. This property is added by the Sync Gateway when it processes the document.
You can learn more about how image Blob types are mapped to attachments here in the Couchbase Lite documentation: {cbl-blobs--xref}.
<.> Record the revision Id of the document. You will need this when you update the document

. In the command terminal, issue the following command to update the user profile document via link:[PUT Document REST API]
+
[source,bash]
----
curl -X PUT \
  'http://localhost:4985/userprofile/user::demo@example.com?rev=3-12d203d6024c8b844c5ed736c726ac63379e05dc' \
  -H 'Accept: application/json' \
  -H 'Cache-Control: no-cache' \
  -H 'Content-Type: application/json' \
  -d '{
    "address": "101 Main Street", //<.>
    "email": "demo@example.com",
    "image": {
        "@type": "blob",
        "content_type": "image/jpeg",
        "digest": "sha1-S8asPSgzA+F+fp8/2DdIy4K+0U8=",
        "length": 14989
    },
    "name": "",
    "type": "user",
    "university": "British Institute in Paris, University of London"
}'
----
<.> I updated the university field via the REST API. You can choose to update any other profile information

. Confirm that you get a HTTP _"201 Created"_ status code

. As soon as you update the document via the Sync Gateway REST API, confirm that the changes show up in the mobile app on the simulator.
+
image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/sync/content/modules/userprofile/assets/images/sync_from_sgw.gif[App Sync]

// NOTE: From <<Exercise 2>> above, you observed that changes made on the Sync Gateway are propagated to the Couchbase Lite clients. However, if you tried to update the attachment / image using the link:[Attachments REST API], you would not see the image getting updated on the client side. This is a link:[known issue] in 2.0 and should be fixed in the next release.


== Handling Conflicts during Data Syncronization
Data conflicts are inevtiable in an environment where you can potentially have multiple writes updating the same data concurrently. Couchbase MObile 2.0 supports _Automated Conflict Resolution_.

You can learn more about automated conflict resolution in this link:https://blog.couchbase.com/document-conflicts-couchbase-mobile/[blog post].

== Learn More
Congratulations on completing this tutorial!

This tutorial walked you through an example of how to use a Sync Gateway to synchronize data between Couchbase Lite enabled clients. We discussed how to configure your Sync Gateway to enforce relevat access control, authorization and data routing between Couchbase Lite enabled clients.

Check out the following links for further details

=== Further Reading
* link:https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/config-properties/index.html[Sync Gateway Configuration]

* link:TBD[Sync Function API]

* link:https://blog.couchbase.com/data-replication-couchbase-mobile/[Overview of Replication Protocol 2.0]

* link:https://blog.couchbase.com/using-docker-with-couchbase-mobile/[Installing Sync Gateway using Docker]


